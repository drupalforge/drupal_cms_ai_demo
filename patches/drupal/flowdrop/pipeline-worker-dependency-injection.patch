From 75656662d563541b7143c7a163689acc3af4a879 Mon Sep 17 00:00:00 2001
From: David Galeano <david.galeano@factorial.io>
Date: Tue, 6 Jan 2026 12:00:14 +0100
Subject: [PATCH 1/2] Fix PipelineExecutionWorker dependency injection

---
 .../QueueWorker/PipelineExecutionWorker.php   | 38 ++++++++++++++++++-
 1 file changed, 37 insertions(+), 1 deletion(-)

diff --git a/modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php b/modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php
index c70c9dc..306f178 100644
--- a/modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php
+++ b/modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php
@@ -4,6 +4,8 @@
 
 namespace Drupal\flowdrop_runtime\Plugin\QueueWorker;
 
+use Drupal\Core\Plugin\ContainerFactoryPluginInterface;
+use Symfony\Component\DependencyInjection\ContainerInterface;
 use Drupal\Core\Queue\QueueWorkerBase;
 use Drupal\Core\Queue\RequeueException;
 use Drupal\Core\Queue\SuspendQueueException;
@@ -21,7 +23,7 @@
  * cron = {"time" = 60}
  * )
  */
-class PipelineExecutionWorker extends QueueWorkerBase {
+class PipelineExecutionWorker extends QueueWorkerBase implements ContainerFactoryPluginInterface {
 
   /**
    * The asynchronous orchestrator service.
@@ -44,11 +46,45 @@ class PipelineExecutionWorker extends QueueWorkerBase {
    */
   protected $loggerFactory;
 
+  /**
+   * {@inheritdoc}
+   */
+  public static function create(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition) {
+    return new static(
+      $configuration,
+      $plugin_id,
+      $plugin_definition,
+      $container->get('flowdrop_runtime.asynchronous_orchestrator'),
+      $container->get('entity_type.manager'),
+      $container->get('logger.factory')
+    );
+  }
+
+  /**
+   * Constructs a PipelineExecutionWorker object.
+   *
+   * @param array $configuration
+   *   A configuration array containing information about the plugin instance.
+   * @param string $plugin_id
+   *   The plugin_id for the plugin instance.
+   * @param mixed $plugin_definition
+   *   The plugin implementation definition.
+   * @param \Drupal\flowdrop_runtime\Service\Orchestrator\AsynchronousOrchestrator $asynchronous_orchestrator
+   *   The asynchronous orchestrator service.
+   * @param \Drupal\Core\Entity\EntityTypeManagerInterface $entity_type_manager
+   *   The entity type manager.
+   * @param \Drupal\Core\Logger\LoggerChannelFactoryInterface $logger_factory
+   *   The logger factory.
+   */
   public function __construct(
+    array $configuration,
+    $plugin_id,
+    $plugin_definition,
     AsynchronousOrchestrator $asynchronous_orchestrator,
     EntityTypeManagerInterface $entity_type_manager,
     LoggerChannelFactoryInterface $logger_factory,
   ) {
+    parent::__construct($configuration, $plugin_id, $plugin_definition);
     $this->asynchronousOrchestrator = $asynchronous_orchestrator;
     $this->entityTypeManager = $entity_type_manager;
     $this->loggerFactory = $logger_factory;
-- 
2.39.5 (Apple Git-154)


From 8883759ab27d852ddf40cc058a6ae4f5d1dcc4e5 Mon Sep 17 00:00:00 2001
From: David Galeano <david.galeano@factorial.io>
Date: Tue, 6 Jan 2026 12:03:55 +0100
Subject: [PATCH 2/2] Fix JobExecutionWorker dependency injection too

---
 .../Plugin/QueueWorker/JobExecutionWorker.php | 44 ++++++++++++-
 .../PipelineExecutionWorker.php.rej           | 66 +++++++++++++++++++
 2 files changed, 108 insertions(+), 2 deletions(-)
 create mode 100644 modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php.rej

diff --git a/modules/flowdrop_runtime/src/Plugin/QueueWorker/JobExecutionWorker.php b/modules/flowdrop_runtime/src/Plugin/QueueWorker/JobExecutionWorker.php
index 7ee8c0a..2356a4b 100644
--- a/modules/flowdrop_runtime/src/Plugin/QueueWorker/JobExecutionWorker.php
+++ b/modules/flowdrop_runtime/src/Plugin/QueueWorker/JobExecutionWorker.php
@@ -4,6 +4,8 @@
 
 namespace Drupal\flowdrop_runtime\Plugin\QueueWorker;
 
+use Drupal\Core\Plugin\ContainerFactoryPluginInterface;
+use Symfony\Component\DependencyInjection\ContainerInterface;
 use Drupal\Core\Queue\QueueWorkerBase;
 use Drupal\Core\Queue\RequeueException;
 use Drupal\Core\Queue\SuspendQueueException;
@@ -23,14 +25,52 @@
  * cron = {"time" = 60}
  * )
  */
-class JobExecutionWorker extends QueueWorkerBase {
+class JobExecutionWorker extends QueueWorkerBase implements ContainerFactoryPluginInterface {
 
+  /**
+   * {@inheritdoc}
+   */
+  public static function create(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition) {
+    return new static(
+      $configuration,
+      $plugin_id,
+      $plugin_definition,
+      $container->get('flowdrop_runtime.node_runtime'),
+      $container->get('flowdrop_runtime.asynchronous_orchestrator'),
+      $container->get('entity_type.manager'),
+      $container->get('logger.factory')
+    );
+  }
+
+  /**
+   * Constructs a JobExecutionWorker object.
+   *
+   * @param array $configuration
+   *   A configuration array containing information about the plugin instance.
+   * @param string $plugin_id
+   *   The plugin_id for the plugin instance.
+   * @param mixed $plugin_definition
+   *   The plugin implementation definition.
+   * @param \Drupal\flowdrop_runtime\Service\Runtime\NodeRuntimeService $nodeRuntime
+   *   The node runtime service.
+   * @param \Drupal\flowdrop_runtime\Service\Orchestrator\AsynchronousOrchestrator $asynchronousOrchestrator
+   *   The asynchronous orchestrator service.
+   * @param \Drupal\Core\Entity\EntityTypeManagerInterface $entityTypeManager
+   *   The entity type manager.
+   * @param \Drupal\Core\Logger\LoggerChannelFactoryInterface $loggerFactory
+   *   The logger factory.
+   */
   public function __construct(
+    array $configuration,
+    $plugin_id,
+    $plugin_definition,
     protected NodeRuntimeService $nodeRuntime,
     protected AsynchronousOrchestrator $asynchronousOrchestrator,
     protected EntityTypeManagerInterface $entityTypeManager,
     protected LoggerChannelFactoryInterface $loggerFactory,
-  ) {}
+  ) {
+    parent::__construct($configuration, $plugin_id, $plugin_definition);
+  }
 
   /**
    * {@inheritdoc}
diff --git a/modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php.rej b/modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php.rej
new file mode 100644
index 0000000..fbef9c2
--- /dev/null
+++ b/modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php.rej
@@ -0,0 +1,66 @@
+--- modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php
++++ modules/flowdrop_runtime/src/Plugin/QueueWorker/PipelineExecutionWorker.php
+@@ -4,6 +4,8 @@
+ 
+ namespace Drupal\flowdrop_runtime\Plugin\QueueWorker;
+ 
++use Drupal\Core\Plugin\ContainerFactoryPluginInterface;
++use Symfony\Component\DependencyInjection\ContainerInterface;
+ use Drupal\Core\Queue\QueueWorkerBase;
+ use Drupal\Core\Queue\RequeueException;
+ use Drupal\Core\Queue\SuspendQueueException;
+@@ -21,7 +23,7 @@
+  * cron = {"time" = 60}
+  * )
+  */
+-class PipelineExecutionWorker extends QueueWorkerBase {
++class PipelineExecutionWorker extends QueueWorkerBase implements ContainerFactoryPluginInterface {
+ 
+   /**
+    * The asynchronous orchestrator service.
+@@ -44,11 +46,45 @@ class PipelineExecutionWorker extends QueueWorkerBase {
+    */
+   protected $loggerFactory;
+ 
++  /**
++   * {@inheritdoc}
++   */
++  public static function create(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition) {
++    return new static(
++      $configuration,
++      $plugin_id,
++      $plugin_definition,
++      $container->get('flowdrop_runtime.asynchronous_orchestrator'),
++      $container->get('entity_type.manager'),
++      $container->get('logger.factory')
++    );
++  }
++
++  /**
++   * Constructs a PipelineExecutionWorker object.
++   *
++   * @param array $configuration
++   *   A configuration array containing information about the plugin instance.
++   * @param string $plugin_id
++   *   The plugin_id for the plugin instance.
++   * @param mixed $plugin_definition
++   *   The plugin implementation definition.
++   * @param \Drupal\flowdrop_runtime\Service\Orchestrator\AsynchronousOrchestrator $asynchronous_orchestrator
++   *   The asynchronous orchestrator service.
++   * @param \Drupal\Core\Entity\EntityTypeManagerInterface $entity_type_manager
++   *   The entity type manager.
++   * @param \Drupal\Core\Logger\LoggerChannelFactoryInterface $logger_factory
++   *   The logger factory.
++   */
+   public function __construct(
++    array $configuration,
++    $plugin_id,
++    $plugin_definition,
+     AsynchronousOrchestrator $asynchronous_orchestrator,
+     EntityTypeManagerInterface $entity_type_manager,
+     LoggerChannelFactoryInterface $logger_factory,
+   ) {
++    parent::__construct($configuration, $plugin_id, $plugin_definition);
+     $this->asynchronousOrchestrator = $asynchronous_orchestrator;
+     $this->entityTypeManager = $entity_type_manager;
+     $this->loggerFactory = $logger_factory;
-- 
2.39.5 (Apple Git-154)

