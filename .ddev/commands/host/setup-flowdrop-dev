#!/usr/bin/env bash

## Description: Sets up flowdrop dev environment
## Usage: setup-flowdrop-dev
## Example: "ddev setup-flowdrop-dev"
## ExecRaw: true

if [ -d "modules/flowdrop_ui_agents" ]; then
  echo "Flowdrop UI Agents module already cloned, skipping..."
else
  echo "Cloning the Flowdrop UI Agents module from the Flowdrop repository..."
  cd modules && git clone git@git.drupal.org:project/flowdrop_ui_agents.git && cd ..
fi

echo "Removing the current contrib version of Flowdrop UI Agents..."
ddev exec "rm -rf web/modules/contrib/flowdrop_ui_agents"

echo "Setting up symlinks for Flowdrop modules..."
ddev exec "ln -sf /var/www/html/modules/flowdrop_ui_agents web/modules/contrib/flowdrop_ui_agents"

echo "Setting up symlinks for custom modules..."
ddev exec "mkdir -p web/modules/custom && ln -sf /var/www/html/modules/alt_text_tools web/modules/custom/alt_text_tools"

echo "Applying AI recipe..."
ddev exec 'if [ -n "$OPENAI_API_KEY" ]; then
  echo "Using OPENAI_API_KEY from environment..."
  drush recipe ../recipes/drupal_cms_ai --input=drupal_cms_ai.provider=openai --input=drupal_cms_ai.openai_api_key="$OPENAI_API_KEY"
else
  echo "No OPENAI_API_KEY found. You will be prompted for an API key..."
  drush recipe ../recipes/drupal_cms_ai
fi'

echo "Note: Module installation, demo recipes, and configuration are handled by .devpanel/init.sh"
echo "Clearing cache..."
ddev drush cr

echo "Done! FlowDrop dev environment is ready."
