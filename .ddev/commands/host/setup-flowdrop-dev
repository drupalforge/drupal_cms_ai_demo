#!/usr/bin/env bash

## Description: Sets up flowdrop dev environment
## Usage: setup-flowdrop-dev
## Example: "ddev setup-flowdrop-dev"
## ExecRaw: true

if [ -d "modules/flowdrop_ui_agents" ]; then
  echo "Flowdrop UI Agents module already cloned, skipping..."
else
  echo "Cloning the Flowdrop UI Agents module from the Flowdrop repository..."
  cd modules && git clone git@git.drupal.org:project/flowdrop_ui_agents.git && cd ..
fi

echo "Removing the current contrib version of Flowdrop UI Agents..."
ddev exec "rm -rf web/modules/contrib/flowdrop_ui_agents"

echo "Setting up symlinks for Flowdrop modules..."
ddev exec "ln -sf /var/www/html/modules/flowdrop_ui_agents web/modules/contrib/flowdrop_ui_agents"

echo "Applying AI recipe..."
ddev exec 'if [ -n "$OPENAI_API_KEY" ]; then
  echo "Using OPENAI_API_KEY from environment..."
  drush recipe ../recipes/drupal_cms_ai --input=drupal_cms_ai.provider=openai --input=drupal_cms_ai.openai_api_key="$OPENAI_API_KEY"
else
  echo "No OPENAI_API_KEY found. You will be prompted for an API key..."
  drush recipe ../recipes/drupal_cms_ai
fi'

echo "Enabling Tool module and submodules..."
ddev drush en -y tool tool_ai_connector tool_content tool_content_translation tool_entity tool_system tool_explorer tool_user

echo "Enabling AI explorer and logging modules..."
ddev drush en -y ai_agents_explorer ai_api_explorer ai_logging ai_observability

echo "Enabling FlowDrop core modules..."
ddev drush en -y flowdrop flowdrop_ui flowdrop_runtime flowdrop_pipeline flowdrop_workflow

echo "Enabling FlowDrop AI integration..."
ddev drush en -y flowdrop_ai flowdrop_ui_agents

echo "Enabling AI logging (requests and responses)..."
ddev drush cset -y ai_logging.settings prompt_logging 1
ddev drush cset -y ai_logging.settings prompt_logging_output 1

echo "Applying Bundle Lister Demo recipe..."
ddev drush recipe ../recipes/bundle_lister_demo

echo "Applying Alt Text Evaluator Demo recipe..."
ddev drush recipe ../recipes/alt_text_evaluator_demo

echo "Disabling Klaro consent for DeepChat chatbot..."
ddev drush cset -y klaro.klaro_app.deepchat status 0

echo "Clearing cache..."
ddev drush cr

echo "Done! FlowDrop dev environment is ready."
